import {
  Block,
  BlockItem,
  BlockItemContent,
  BlockItemHeader,
  BlockItemTitle,
} from "@/components/service/panel/content/undeployed/block";
import { Button } from "@/components/ui/button";
import { cn } from "@/components/ui/utils";
import { isDomain } from "@/lib/helpers/is-domain";
import { withForm } from "@/lib/hooks/use-app-form";
import { CheckCircleIcon, CircleSlashIcon, EyeOffIcon } from "lucide-react";

const DomainPortBlock = withForm({
  defaultValues: {
    isPublic: true,
    domain: "",
    port: "",
  },
  props: {
    autoGeneratedDomain: undefined as string | undefined,
    detectedPort: undefined as string | undefined,
  },
  render: function Render({ form, detectedPort, autoGeneratedDomain }) {
    return (
      <Block>
        <BlockItem>
          <BlockItemHeader>
            <BlockItemTitle>Domain</BlockItemTitle>
            <form.AppField
              name="isPublic"
              children={(field) => (
                <Button
                  type="button"
                  variant="ghost"
                  onClick={() => {
                    const newIsPublic = !field.state.value;
                    if (!newIsPublic) {
                      form.setErrorMap({
                        onChange: { fields: { domain: undefined, port: undefined } },
                      });
                    }
                    field.handleChange(newIsPublic);
                  }}
                  data-private={!field.state.value ? true : undefined}
                  className="group/button has-hover:hover:bg-border -my-1 -mr-0.5 ml-auto flex cursor-pointer items-center justify-center gap-2.5 rounded-full py-1 pr-1 pl-2.5 font-medium"
                >
                  <p className="text-muted-foreground group-data-private/button:text-foreground has-hover:group-hover/button:text-foreground min-w-0 shrink">
                    Private
                  </p>
                  <div className="bg-muted-more-foreground group-data-private/button:bg-foreground relative h-5 w-9 rounded-full transition">
                    <div className="bg-background absolute top-0.5 left-0.5 size-4 rounded-full transition group-data-private/button:translate-x-4" />
                  </div>
                </Button>
              )}
            />
          </BlockItemHeader>
          <BlockItemContent>
            <form.Subscribe
              selector={(state) => ({ isPublic: state.values.isPublic })}
              children={({ isPublic }) => (
                <>
                  {!isPublic && <PrivateServiceField />}
                  <form.AppField
                    name="domain"
                    validators={{
                      onChange: ({ value }) => validateDomain({ value, isPublic }),
                    }}
                    children={(field) => (
                      <field.DomainInput
                        className={cn(!isPublic && "hidden")}
                        disabled={!isPublic}
                        field={field}
                        value={field.state.value}
                        onBlur={field.handleBlur}
                        onChange={(e) => {
                          field.handleChange(e.target.value);
                        }}
                        placeholder="example.com"
                        autoCapitalize="off"
                        autoCorrect="off"
                        autoComplete="off"
                        spellCheck="false"
                        autoGeneratedDomain={!isPublic ? undefined : autoGeneratedDomain}
                      />
                    )}
                  />
                </>
              )}
            />
          </BlockItemContent>
        </BlockItem>
        {/* Branch */}
        <BlockItem>
          <BlockItemHeader>
            <BlockItemTitle>Port</BlockItemTitle>
            <form.Subscribe
              selector={(state) => ({ isPublic: state.values.isPublic })}
              children={({ isPublic }) => {
                if (!isPublic) return null;
                return (
                  <div
                    data-detected={detectedPort !== undefined ? true : undefined}
                    className="bg-warning/10 text-warning border-warning/10 data-detected:text-success data-detected:bg-success/10 data-detected:border-success/10 -my-1 ml-auto flex min-w-0 shrink items-center justify-start gap-1.5 rounded-full border px-2 py-0.5"
                  >
                    {detectedPort !== undefined ? (
                      <CheckCircleIcon className="-ml-0.75 size-3.5 shrink-0" />
                    ) : (
                      <CircleSlashIcon className="-ml-0.75 size-3.5 shrink-0" />
                    )}
                    <p className="min-w-0 shrink truncate text-sm leading-tight font-medium">
                      {detectedPort !== undefined ? (
                        <>
                          Detected: <span className="font-bold">{detectedPort}</span>
                        </>
                      ) : (
                        "Couldn't detect"
                      )}
                    </p>
                  </div>
                );
              }}
            />
          </BlockItemHeader>
          <BlockItemContent>
            <form.Subscribe
              selector={(state) => ({ isPublic: state.values.isPublic })}
              children={({ isPublic }) => (
                <>
                  {!isPublic && <PrivateServiceField />}
                  <form.AppField
                    name="port"
                    validators={{
                      onChange: ({ value }) => validatePort({ value, isPublic }),
                    }}
                    children={(field) => (
                      <field.TextField
                        className={cn(!isPublic && "hidden")}
                        disabled={!isPublic}
                        field={field}
                        value={field.state.value}
                        onBlur={field.handleBlur}
                        onChange={(e) => {
                          field.handleChange(e.target.value);
                        }}
                        showUndo={detectedPort !== undefined && field.state.value !== detectedPort}
                        onUndo={() => {
                          if (detectedPort !== undefined) {
                            field.handleChange(detectedPort);
                          }
                        }}
                        placeholder="3000"
                        autoCapitalize="off"
                        autoCorrect="off"
                        autoComplete="off"
                        spellCheck="false"
                        inputMode="numeric"
                      />
                    )}
                  />
                </>
              )}
            />
          </BlockItemContent>
        </BlockItem>
      </Block>
    );
  },
});

export default DomainPortBlock;

function PrivateServiceField() {
  return (
    <div className="bg-input text-muted-foreground flex w-full items-center gap-2 rounded-lg border px-3 py-2.5 font-medium">
      <EyeOffIcon className="size-5 shrink-0 scale-90" />
      <p className="min-w-0 shrink truncate leading-tight">Private service</p>
    </div>
  );
}

function validatePort({ value, isPublic }: { value: string; isPublic: boolean }) {
  if (!isPublic) return undefined;
  if (!value) return { message: "Port is required on public services." };
  // check if the value contains only digits
  if (!/^\d+$/.test(value)) {
    return { message: "Port must be a positive integer." };
  }
  const portNumber = parseInt(value, 10);
  if (isNaN(portNumber)) {
    return { message: "Port must be a positive integer." };
  }
  if (portNumber < 1 || portNumber > 65535) {
    return { message: "Port must be between 1 and 65535." };
  }
  return undefined;
}

function validateDomain({ value, isPublic }: { value: string; isPublic: boolean }) {
  if (!isPublic) return undefined;
  if (!value) return { message: "Domain is required on public services." };
  const isValidDomain = isDomain(value);
  if (!isValidDomain) {
    return { message: "Invalid domain." };
  }
  return undefined;
}
